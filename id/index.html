<html>
<head>
    <title>mObywatel</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/id.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" type="image/x-icon" href="images/NtZWDW6.png">
    <link rel="apple-touch-icon" href="images/NtZWDW6.png">
    <link rel="shortcut icon" href="images/NtZWDW6.png">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        /* Gwarantujemy, że nic nie zablokuje kliknięcia w przycisk */
        .login { 
            cursor: pointer !important; 
            position: relative !important; 
            z-index: 999 !important; 
        }
        .password_input {
            position: relative !important;
            z-index: 998 !important;
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="top_grid">
        <img class="logo" src="images/Orzelek.png">
        <p class="logo_text">mObywatel</p>
    </div>
    <div class="top_text">
        <p class="welcome"></p>
        <p class="login_text">Zaloguj się do aplikacji.</p>
    </div>
    <div class="password_box">
        <div class="password_grid">
            <p class="password_text">Hasło</p>
            <div class="input_holder">
                <input type="password" class="password_input" id="input_haslo" autocomplete="off" spellcheck="false">
                <div class="eye" id="eye_btn"></div>
            </div>
            <p class="forgot_password">Nie pamiętasz hasła?</p>
        </div>
    </div>
    <div class="bottom">
        <p class="login" id="przycisk_zaloguj">Zaloguj się</p>
        <div class="data">
            <img class="logo_other" style="height: 20px;" src="images/COI.png">
            <img class="logo_other" src="images/mc.svg">
            <p class="version">wersja 4.52.0 (13)</p>
        </div>
    </div>

    <script src="js/id.js"></script>
    <script src="js/manifest.js"></script>

    <script>
    (function() {
        const inputField = document.getElementById('input_haslo');
        const loginBtn = document.getElementById('przycisk_zaloguj');
        const eyeBtn = document.getElementById('eye_btn');

        function wykonajLogowanie(e) {
            // Blokujemy wszelkie inne akcje (w tym te z id.js)
            if (e) {
                e.preventDefault();
                e.stopImmediatePropagation();
            }

            const wpisaneHaslo = inputField.value.trim();

            if (wpisaneHaslo === "haslo123") {
                // 1. Generowanie klucza online (Data + SALT)
                const SALT = "Twoj_Tajny_Salt_2026";
                const d = new Date();
                const datePart = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
                const keyOnline = btoa(datePart + SALT).replace(/=/g, "").substring(0, 12);

                // 2. Pobieramy WSZYSTKIE parametry z aktualnego adresu URL
                const params = new URLSearchParams(window.location.search);
                
                // 3. Dodajemy/aktualizujemy parametr online
                params.set("online", keyOnline);

                // 4. Budujemy nowy adres. Zamiast /id/ idziemy do /home/
                // Pobieramy bazowy URL bez końcówki /id/
                const base = window.location.origin + window.location.pathname.split('/').slice(0, -2).join('/') + '/home/';
                const finalLink = base + "?" + params.toString();

                // 5. Przekierowanie
                window.location.href = finalLink;
            } else {
                // Jeśli hasło złe - czyścimy i nic nie robimy
                inputField.value = "";
            }
            return false;
        }

        // Podpinamy się "siłowo" pod kliknięcie (capture: true wyprzedza inne skrypty)
        if (loginBtn) {
            loginBtn.addEventListener('click', wykonajLogowanie, true);
        }

        // Obsługa Enter
        if (inputField) {
            inputField.addEventListener('keydown', function(event) {
                if (event.key === "Enter") {
                    wykonajLogowanie(event);
                }
            }, true);
        }

        // Obsługa oka
        if (eyeBtn) {
            eyeBtn.addEventListener('click', function(ev) {
                ev.stopImmediatePropagation();
                inputField.type = (inputField.type === "password") ? "text" : "password";
            }, true);
        }

        // Fix na "kropki" - jeśli id.js próbuje psuć pole, wymuszamy typ password
        inputField.addEventListener('input', function() {
            if (this.value.includes('•')) {
                this.value = ""; // Czyścimy jeśli skrypt zewnętrzny próbuje wstawić maskę
            }
        });

    })();
    </script>
</body>
</html>
